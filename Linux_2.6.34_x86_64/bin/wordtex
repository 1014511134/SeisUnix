#! /bin/sh
# Shell: wordtex
# Author: John Stockwell 26 July 1990
# a spell checker for TeX and LaTeX documents, based largely on 
# Jack Cohen's program   wwb

#set -x

ROOT=/usr/local
SRC=$ROOT
BIN=$ROOT/cwp/bin

PATH=/bin:/usr/bin:/usr/sbin:$BIN

cmd=`basename $0`
typos=/tmp/$$.dict
typos1=/tmp/$$.dict1
exceptions=/usr/local/textproc/words/words
exceptions2=/usr/dict/words

case $# in
	1) # Normal usage
	;;
	*) echo Usage: $cmd file 1>&2; exit 1
	;;
esac
out=wt.$1	# Name of output file.
echo > $out
echo File $1: >>$out
# Start spelling checker
echo Typos: >>$out
trap 'rm $typos $typos1 1>/dev/null 2>/dev/null' 0 1 2 15

# use delatex to strip out LaTeXisms and pass through spell
cat $1  | sed '
s/\\ref{.*}//
s/\\label{.*}//
s/\\epsffile{.*}//
s/{equation}//
s/{eqnarray\*}//
s/\\qquad//
s/\\quad//
s/\\\!//
' | delatex | spell -t | sed ' s/	//' > $typos


# spell sorts with -f option; but comm demands ASCII collating sequence!
sort -u -b -o $typos $typos
comm -23 $typos $exceptions >$typos1
comm -23 $typos1 $exceptions2 |
sed 's/^/	/' >>$out

# Start double word checker
echo Double words: >>$out

cat $1 | sed '
s/\\ref{.*}//
s/\\label{.*}//
s/\\epsffile{.*}//
s/{equation}//
s/{eqnarray\*}//
s/\,/ /g
s/\\qquad//
s/\\quad//
s/\\\!//
s/\&//
' | delatex  | tr A-Z a-z |
awk '
	NF > 0 {
		if ($1 == lastword)
			printf "%s, line %d\n", $1, NR
		for (i = 2; i<= NF; i++)
			if ($i == $(i-1))
				printf "%s, line %d\n", $i, NR
		if (NF > 0)
				lastword = $NF
	}
' | sed 's/^/	/' >>$out

## Start cliche checker use delatex to strip out LaTeXisms
echo Cliches: >>$out
cat $1 |
sed '
s/\\ref{.*}//
s/\\label{.*}//
s/\\epsffile{.*}//
s/{equation}//
s/{eqnarray\*}//
' |
delatex | diction >>$out
echo wordtex $1 output ready in $out 1>&2; exit 0
